{% extends 'base.html' %}

{% block title %}Price Comparison{% endblock %}
{% load static %}
{% load custom_tags %}
{% block content %}
    <h1>Price Comparison</h1>

    {% if fully_matched or partially_matched or unmatched %}

        {% if fully_matched %}
            <h3>Stores with All Items (Best Deals) - {{ fully_matched|length }}</h3>
            <ul>
                {% for store, total in fully_matched %}
                    <li>
                        {{ store }}: ${{ total|floatformat:2 }}
                        {% if cheapest_store and store == cheapest_store.name %}
                            <strong>(Cheapest)</strong>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
            {% if cheapest_store and savings %}
                <p> You save ${{ savings|floatformat:2 }} by shopping at {{ cheapest_store.name }}. </p>
            {%  elif cheapest_store %}
                <p> {{ cheapest_store.name }} is the cheapest store.</p>
            {% endif %}
        {% endif %}

        {% if partially_matched %}
            <h3>Stores Missing Some Items - {{ partially_matched|length }}</h3>
            <ul>
                {% for store, total, missing in partially_matched %}
                    <li>
                        {{ store }}: ${{ total|floatformat:2 }} <br>
                        <span style="color: red;">⚠️ Missing prices for: {{ missing|join:", " }}</span>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}

        {% if unmatched %}
            <h3>Stores Missing All Items - {{ unmatched|length }}</h3>
            <ul>
                {% for store in unmatched %}
                    <li>{{ store }} — ❌ No matching items found</li>
                {% endfor %}
            </ul>
        {% endif %}

    {% else %}
        <p>No pricing available for your list.</p>
    {% endif %}

    <a href="{% url 'shopping_list' %}">← Back to Shopping List</a>
{% endblock %}
